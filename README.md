# Practical Malware Analysis Labs- Ch.7 Labs

## In this lab we will analyze some EXEs with IDA disassembler.
---
### Lab07-01.exe Questions:
---
1- How does this program ensure that it continues running (achieves per-
sistence) when the computer is restarted?

First if we look at assemply code of this exe we will see that

![](/Pics/lab1_main.png)

So, we have a service calles "MalService" and calling "StartServiceCtrlDispatcherA" which connects the main thread of a service process to the service control manager, which causes the thread to be the service control dispatcher thread for the calling process.

and then calling function sub_401040, if we digging into this function 

![](/Pics/lab1_creating_service.png)

we will see calling to function called "OpenSCManagerA" which establishes a connection to the service control manager on the specified computer and opens the specified service control manager database. 
and then calling to function "CreateServiceA" with start type = 2 "SERVICE_AUTO_START". So, the malware will start as a service automatically when os starts 

--- 
2- Why does this program use a mutex?

If we look at the start of this function we will that the malware try to open mutex called "HGL345" and if this mutex is with another process "another version of malware", malware will Exit. So, malware use mutex to ensure that only one version of it is running 

![](/Pics/lab1_Open_mutex.png)

---
3- What is a good host-based signature to use for detecting this program?

for detecting this malware we can use mutex hard-coded name "HGL345" to detect it.

--- 
4- What is a good network-based signature for detecting this malware?

By making a search at strings section in this sample using FLOSS, we will find a URL and user agent 

![](/Pics/Lab1_Strings_url.png)

So, we can search for these strings in IDA strings section we get the function where they used.

We will find them in "StartAddress" function, and by examining their function "StartAddress", we will see that malware try to connect to this URL via this user agent.

![](/Pics/lab1_try_to_connect_to_url.png)

So, we can use this URL as a network based indicator to detect this malware.

---
5-What is the purpose of this program?

Back to sub_401040 after "CreatingServiceA" calling we will some stuff seems like to setting time. Setting hour, second and Day of week to zero "edx content" and setting year to "2100"

![](/Pics/Lab1_Setting_time.png)

After this we will see calling to functions also used to setting some time stuff 

![](/Pics/lab1_time_functions.png)

 - SystemTimeToFileTime : Converts a system time to file time format. System time is based on Coordinated Universal Time (UTC).

- CreateWaitableTimerW : Creates or opens a waitable timer object.

- SetWaitableTimer: Activates the specified waitable timer. When the due time arrives, the timer is signaled and the thread that set the timer calls the optional completion routine.

- WaitForSingleObject: Waits until the specified object is in the signaled state or the time-out interval elapses.

**This function time-out interval is 4294967295 = 49,71 days**

So, malware will sleep until the time-out interval ends or the date is reached.

After that, malware will create 20 threads each of them is "StratAddress" which request above URL.

![](/Pics/lab_creating_threads.png)

So, this malware is used to **Denial of service** to this website.

--- 

- When will this program finish executing?

If we see the loop that created thread, it has no condition to stop, and also malware will run again when os rebooted, So this malware won't finish his execution

---
---

### Lab07-02.exe Questions:
---

1- How does this program achieve persistence?

This Malware doesn't any thing that indicate that it try to achieve persistence.

---
2- What is the purpose of this program?

First, this malware call "OleInitialize" which Initializes the COM library on the current apartment, identifies the concurrency model as single-thread apartment (STA), and calls CoInitializeEx internally.
So, we can conclude that COM object will be execute.

![](/Pics/lab2_OleInitailize.png)

If this function sucessfully intialize object it, it will calling "COCreaateInstance" function which Creates and default-initializes a single object of the class associated with a specified CLSID.

is we examint the **CLSID** passing to this function and try to search about it in registry, we will find that this CLSID belongs to Internet Explorer 

![](/Pics/Lab2-InternetExplorer_CLSID.png)

After creating this object, we will see string allocate on memory which is URL (HTML page may contain Advertise)

![](/Pics//lab2_Allocate_URL.png)

So, we can conclude that this malware is **adware**

---
3- When will this program finish executing?

This malware will finish its execution after webpage opened.
